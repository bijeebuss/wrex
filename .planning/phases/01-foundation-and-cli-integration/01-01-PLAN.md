---
phase: 01-foundation-and-cli-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - vite.config.ts
  - drizzle.config.ts
  - src/router.tsx
  - src/client.tsx
  - src/server.tsx
  - src/routes/__root.tsx
  - src/routes/index.tsx
  - src/lib/db/index.ts
  - src/lib/db/schema.ts
  - src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "TanStack Start dev server starts without errors and serves a page at http://localhost:3000"
    - "SQLite database file is created at ./data/wrex.db on first server start"
    - "sqlite-vec extension loads successfully (SELECT vec_version() returns a version string)"
    - "Sessions and messages tables exist with correct schema"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with all Phase 1 dependencies"
      contains: "@tanstack/react-start"
    - path: "vite.config.ts"
      provides: "Vite build config with TanStack Start plugin"
      contains: "tanstackStart"
    - path: "src/lib/db/index.ts"
      provides: "Database singleton with sqlite-vec loaded"
      exports: ["db", "sqlite"]
    - path: "src/lib/db/schema.ts"
      provides: "Drizzle schema for sessions and messages tables"
      exports: ["sessions", "messages"]
    - path: "src/routes/index.tsx"
      provides: "Home page route serving HTML"
      min_lines: 10
    - path: "src/server.tsx"
      provides: "Server entry point"
      contains: "createStartHandler"
    - path: "src/client.tsx"
      provides: "Client entry point"
      contains: "hydrateRoot"
    - path: "src/router.tsx"
      provides: "Router factory"
      contains: "createRouter"
  key_links:
    - from: "src/lib/db/index.ts"
      to: "src/lib/db/schema.ts"
      via: "import * as schema"
      pattern: "import.*schema"
    - from: "src/lib/db/index.ts"
      to: "better-sqlite3"
      via: "Database constructor + sqliteVec.load"
      pattern: "sqliteVec\\.load"
    - from: "vite.config.ts"
      to: "@tanstack/react-start/plugin/vite"
      via: "tanstackStart plugin"
      pattern: "tanstackStart"
    - from: "src/server.tsx"
      to: "src/router.tsx"
      via: "createRouter import"
      pattern: "createRouter"
---

<objective>
Scaffold the Wrex project from scratch: TanStack Start web server, SQLite database with Drizzle ORM, sqlite-vec extension loading, and session/message schema.

Purpose: Establishes the complete project foundation that Plan 02 (Claude Code process manager + SSE) will build on. After this plan, the dev server runs and the database is ready for data.
Output: A working TanStack Start application with SQLite database, Drizzle ORM schema (sessions + messages), and sqlite-vec extension validated.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-cli-integration/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold TanStack Start project with all Phase 1 dependencies</name>
  <files>
    package.json
    tsconfig.json
    vite.config.ts
    src/router.tsx
    src/client.tsx
    src/server.tsx
    src/routes/__root.tsx
    src/routes/index.tsx
    src/styles/global.css
  </files>
  <action>
Create the Wrex project from scratch in /workspaces/assistant. Do NOT use `npm create @tanstack/start` -- create files manually to avoid interactive prompts and ensure exact control.

1. Create `package.json` with these dependencies:
   - dependencies: `@tanstack/react-start` (^1.159.5), `@tanstack/react-router` (^1.159.5), `react` (^19), `react-dom` (^19), `drizzle-orm` (^0.45.1), `better-sqlite3` (^12.6.2), `sqlite-vec` (^0.1.7-alpha.2), `zod` (^3.24)
   - devDependencies: `@types/react` (^19), `@types/react-dom` (^19), `@types/better-sqlite3`, `drizzle-kit`, `typescript` (^5.7), `vite` (^6), `vite-tsconfig-paths`, `@types/node`
   - scripts: `"dev": "vite"`, `"build": "vite build"`, `"start": "node .output/server/index.mjs"`, `"db:push": "drizzle-kit push"`, `"db:generate": "drizzle-kit generate"`, `"db:studio": "drizzle-kit studio"`

2. Create `tsconfig.json` with:
   - `"compilerOptions"`: target ES2022, module ESNext, moduleResolution bundler, jsx react-jsx, strict true, esModuleInterop true, skipLibCheck true, paths `{"@/*": ["./src/*"]}`
   - `"include"`: ["src"]

3. Create `vite.config.ts` following the RESEARCH.md Pattern (Vite-based, NOT Vinxi):
   ```typescript
   import { defineConfig } from 'vite'
   import { tanstackStart } from '@tanstack/react-start/plugin/vite'
   import tsconfigPaths from 'vite-tsconfig-paths'

   export default defineConfig({
     plugins: [tsconfigPaths(), tanstackStart()],
   })
   ```

4. Create `src/router.tsx` -- router factory with routeTree import (see RESEARCH.md Pattern 4 - Router Setup).

5. Create `src/client.tsx` -- client entry that calls `hydrateRoot` with `StartClient` and `createRouter`.

6. Create `src/server.tsx` -- server entry using `createStartHandler` with `defaultStreamHandler` (see RESEARCH.md Pattern 1).

7. Create `src/routes/__root.tsx` -- root layout with HTML shell (`<html>`, `<head>`, `<body>`, `<Outlet />`). Include a `<Scripts />` component from `@tanstack/react-start`. Include a basic `<meta charset="utf-8">` and viewport meta tag. Link to a global CSS file.

8. Create `src/routes/index.tsx` -- home page route that renders a simple heading "Wrex" and a subtitle "AI Assistant". This is a placeholder that proves the server works. Use `createFileRoute('/')`.

9. Create `src/styles/global.css` with minimal reset (box-sizing, margin 0, font-family sans-serif, dark background #1a1a2e with light text #e0e0e0).

10. Run `npm install` to install all dependencies. Verify no errors.

11. Create `data/` directory (for the SQLite database file). Add `data/.gitkeep`.

12. Create `.gitignore` with: node_modules, .output, dist, data/*.db, .vinxi, .env

IMPORTANT: Use the NEW TanStack Start API (post-Vinxi migration):
- `@tanstack/react-start` NOT `@tanstack/start`
- `vite.config.ts` NOT `app.config.ts`
- `createServerFileRoute` NOT `createAPIFileRoute`
- Default `src/` directory NOT `app/`
  </action>
  <verify>
Run `npx vite --version` to confirm Vite is installed. Run `npx tsc --noEmit` to confirm TypeScript compiles (may have warnings about routeTree.gen -- that is OK, it generates on first dev server start). Verify `node_modules/@tanstack/react-start` exists. Verify `node_modules/better-sqlite3` exists. Verify `node_modules/sqlite-vec` exists.
  </verify>
  <done>All dependencies installed without errors. TypeScript config valid. Project structure matches RESEARCH.md recommended layout.</done>
</task>

<task type="auto">
  <name>Task 2: Create SQLite database layer with Drizzle ORM, sqlite-vec, and session schema</name>
  <files>
    src/lib/db/index.ts
    src/lib/db/schema.ts
    drizzle.config.ts
  </files>
  <action>
1. Create `src/lib/db/schema.ts` with Drizzle schema definitions (from RESEARCH.md verified pattern):
   - `sessions` table: id (text PK, UUID), claudeSessionId (text, nullable -- Claude Code's session ID for --resume), title (text, nullable), status (text, not null, default 'active'), createdAt (integer timestamp_ms, default unixepoch*1000), updatedAt (integer timestamp_ms, default unixepoch*1000)
   - `messages` table: id (text PK, UUID), sessionId (text, not null, FK -> sessions.id with cascade delete), role (text, not null -- 'user'|'assistant'|'system'), content (text, not null), toolUse (text, nullable -- JSON string of tool use blocks), claudeMessageId (text, nullable), costUsd (integer, nullable -- micro-dollars), inputTokens (integer, nullable), outputTokens (integer, nullable), durationMs (integer, nullable), createdAt (integer timestamp_ms, default unixepoch*1000)

2. Create `src/lib/db/index.ts` -- database singleton:
   - Import Database from better-sqlite3 and sqliteVec from sqlite-vec
   - Import drizzle from drizzle-orm/better-sqlite3
   - Import schema from ./schema
   - Use DB_PATH from `process.env.DB_PATH || './data/wrex.db'`
   - Ensure parent directory exists using `mkdirSync` with recursive
   - Create Database instance with DB_PATH
   - Set pragmas: `journal_mode = WAL`, `foreign_keys = ON`
   - Load sqlite-vec: `sqliteVec.load(sqlite)`
   - Validate sqlite-vec with `sqlite.prepare('SELECT vec_version() as version').get()` and log the version
   - Create drizzle instance: `drizzle(sqlite, { schema })`
   - Export both `db` (Drizzle instance) and `sqlite` (raw better-sqlite3 instance for direct extension queries)

3. Create `drizzle.config.ts`:
   ```typescript
   import { defineConfig } from 'drizzle-kit'
   export default defineConfig({
     schema: './src/lib/db/schema.ts',
     out: './drizzle',
     dialect: 'sqlite',
     dbCredentials: { url: process.env.DB_PATH || './data/wrex.db' },
   })
   ```

4. Run `npx drizzle-kit push` to create the tables in the SQLite database.

5. Verify the database was created and tables exist by running a quick Node.js script:
   ```bash
   node -e "
     const Database = require('better-sqlite3');
     const sqliteVec = require('sqlite-vec');
     const db = new Database('./data/wrex.db');
     sqliteVec.load(db);
     console.log('vec_version:', db.prepare('SELECT vec_version()').get());
     console.log('tables:', db.prepare(\"SELECT name FROM sqlite_master WHERE type='table'\").all());
   "
   ```

6. Start the dev server with `npx vite` (or `npm run dev`) and verify it starts. The database module should initialize when the server loads. If TanStack Start's dev server starts on a port, verify with curl that the home page returns HTML.

IMPORTANT: The database singleton must load sqlite-vec BEFORE wrapping with Drizzle. Order matters: new Database() -> pragmas -> sqliteVec.load() -> drizzle().

NOTE on Drizzle + sqlite-vec interop: Drizzle handles sessions/messages CRUD. Raw `sqlite` handle will be used in Phase 2 for vector operations (sqlite-vec virtual tables). Both coexist on the same connection.
  </action>
  <verify>
Run `node -e "const db = require('better-sqlite3')('./data/wrex.db'); const sv = require('sqlite-vec'); sv.load(db); console.log(db.prepare('SELECT vec_version()').get()); console.log(db.prepare(\"SELECT name FROM sqlite_master WHERE type='table'\").all())"` -- should print sqlite-vec version and show sessions + messages tables. Run `npm run dev` and verify the server starts (curl http://localhost:3000 should return HTML with "Wrex").
  </verify>
  <done>SQLite database created at ./data/wrex.db. sqlite-vec extension loads and SELECT vec_version() returns a version. Sessions and messages tables exist with correct columns. Drizzle ORM connected. Dev server starts and serves the index page.</done>
</task>

</tasks>

<verification>
1. `npm run dev` starts the TanStack Start dev server without errors
2. Visiting http://localhost:3000 shows the "Wrex" heading
3. `./data/wrex.db` exists and contains sessions + messages tables
4. `SELECT vec_version()` returns a version string from the database
5. TypeScript compiles without errors (`npx tsc --noEmit`)
</verification>

<success_criteria>
- TanStack Start dev server boots and serves HTML at localhost
- SQLite database with WAL mode, foreign keys, sqlite-vec extension loaded
- Drizzle ORM schema with sessions (id, claudeSessionId, title, status, timestamps) and messages (id, sessionId, role, content, toolUse, claudeMessageId, costUsd, tokens, durationMs, timestamp)
- Project has all Phase 1 dependencies installed
- Clean TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-cli-integration/01-01-SUMMARY.md`
</output>
