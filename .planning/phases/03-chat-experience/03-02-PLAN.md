---
phase: 03-chat-experience
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/routes/_chat.tsx
  - src/routes/_chat.index.tsx
  - src/routes/_chat.$sessionId.tsx
  - src/routes/index.tsx
  - src/lib/api/sessions.ts
  - src/components/sidebar/Sidebar.tsx
  - src/components/sidebar/SessionItem.tsx
  - src/server.tsx
  - src/lib/claude/chat-handler.ts
autonomous: true

must_haves:
  truths:
    - "User can start a new chat session with one click from the 'New chat' button at the top of the sidebar"
    - "User can browse past sessions in a sidebar sorted by recency (newest first, flat list)"
    - "User can click a past session to load its full message history and resume the conversation"
    - "Sessions get auto-generated titles from the first user message (first 50 chars, trimmed to last word)"
    - "User can delete a session instantly (no confirmation dialog)"
    - "Sidebar is a collapsible drawer -- visible at >= 768px, hamburger menu on narrow screens"
    - "Each session item shows title and snippet of the last message"
    - "Empty state shows blank chat area with input box ready -- no welcome message"
  artifacts:
    - path: "src/routes/_chat.tsx"
      provides: "Pathless layout route with sidebar and Outlet"
      exports: ["Route"]
    - path: "src/routes/_chat.index.tsx"
      provides: "Empty state / new chat view"
      exports: ["Route"]
    - path: "src/routes/_chat.$sessionId.tsx"
      provides: "Active session view with loaded history"
      exports: ["Route"]
    - path: "src/lib/api/sessions.ts"
      provides: "Server functions for session CRUD"
      exports: ["listSessions", "deleteSession", "loadSessionMessages"]
    - path: "src/components/sidebar/Sidebar.tsx"
      provides: "Collapsible session list drawer"
    - path: "src/components/sidebar/SessionItem.tsx"
      provides: "Single session entry with title, snippet, delete"
  key_links:
    - from: "src/routes/_chat.tsx"
      to: "src/lib/api/sessions.ts"
      via: "route loader calls listSessions"
      pattern: "listSessions"
    - from: "src/routes/_chat.$sessionId.tsx"
      to: "src/lib/api/sessions.ts"
      via: "route loader calls loadSessionMessages"
      pattern: "loadSessionMessages"
    - from: "src/components/sidebar/SessionItem.tsx"
      to: "src/lib/api/sessions.ts"
      via: "delete button calls deleteSession"
      pattern: "deleteSession"
    - from: "src/routes/_chat.index.tsx"
      to: "src/hooks/useChat.ts"
      via: "useChat with no sessionId for new conversations"
      pattern: "useChat"
    - from: "src/routes/_chat.$sessionId.tsx"
      to: "src/hooks/useChat.ts"
      via: "useChat with sessionId and initialMessages from loader"
      pattern: "useChat.*sessionId"
---

<objective>
Add session management with a collapsible sidebar, route-based session navigation, and server functions for session CRUD. Users can start new chats, browse history, resume past sessions, and delete sessions.

Purpose: Transform the single-page chat into a multi-session application where conversations persist and are navigable. The sidebar is the primary navigation mechanism.

Output: A fully routed chat application with sidebar navigation, session persistence, and resume capability. Ready for memory integration in Plan 03-03.
</objective>

<execution_context>
@/home/node/.claude/get-shit-done/workflows/execute-plan.md
@/home/node/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-chat-experience/03-RESEARCH.md
@.planning/phases/03-chat-experience/03-01-SUMMARY.md

Key existing files to reference:
@src/routes/index.tsx (from 03-01, needs restructuring into layout routes)
@src/hooks/useChat.ts (from 03-01, needs sessionId and initialMessages support)
@src/lib/db/schema.ts (sessions and messages tables)
@src/lib/db/index.ts (db and sqlite exports)
@src/lib/claude/chat-handler.ts (needs title generation on first message)
@src/server.tsx (needs new API routes for session listing/deletion)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server functions for session CRUD and add title generation</name>
  <files>
    src/lib/api/sessions.ts
    src/lib/claude/chat-handler.ts
    src/server.tsx
  </files>
  <action>
**Create `src/lib/api/sessions.ts`** with TanStack Start server functions:

```typescript
import { createServerFn } from '@tanstack/react-start'
```

1. `listSessions` -- GET server function:
   - Query sessions ordered by updatedAt desc
   - For each session, include the last message (for snippet display)
   - Use Drizzle relational query: `db.query.sessions.findMany({ orderBy: desc(sessions.updatedAt), with: { messages: { limit: 1, orderBy: desc(messages.createdAt) } } }).sync()`
   - NOTE: For Drizzle relations to work, you need to define relations. Add a `relations` export to schema.ts or define them inline. If the schema doesn't have relations defined, use a raw SQL join instead:
     ```sql
     SELECT s.*, m.content as last_message_content, m.role as last_message_role
     FROM sessions s
     LEFT JOIN (
       SELECT session_id, content, role, ROW_NUMBER() OVER (PARTITION BY session_id ORDER BY created_at DESC) as rn
       FROM messages
     ) m ON m.session_id = s.id AND m.rn = 1
     ORDER BY s.updated_at DESC
     ```
   - Return array of `{ id, title, status, updatedAt, lastMessageSnippet }` -- lastMessageSnippet is first 100 chars of last message content

2. `loadSessionMessages` -- GET server function with validator `{ data: { sessionId: string } }`:
   - Query messages for the session ordered by createdAt asc
   - Return array of `{ id, role, content, toolUse, createdAt }`
   - Also return session metadata (title, claudeSessionId)

3. `deleteSession` -- POST server function with validator `{ data: { sessionId: string } }`:
   - Delete session (cascade will delete messages due to foreign key)
   - `db.delete(sessions).where(eq(sessions.id, data.sessionId)).run()`
   - Return `{ success: true }`

**Update `src/lib/claude/chat-handler.ts`:**
Add auto-generated title when the first message is sent to a new session:

1. After creating the session record (the `else` branch where `!existingSession`), generate a title from the prompt:
   ```typescript
   function generateTitle(firstMessage: string): string {
     const maxLen = 50
     if (firstMessage.length <= maxLen) return firstMessage
     const trimmed = firstMessage.slice(0, maxLen)
     const lastSpace = trimmed.lastIndexOf(' ')
     return (lastSpace > 20 ? trimmed.slice(0, lastSpace) : trimmed) + '...'
   }
   ```
   Set the title in the insert: `{ id: sessionId, status: 'active', title: generateTitle(prompt) }`

2. When resuming an existing session that has no title (shouldn't happen normally, but defensive), generate title from the current prompt if title is null.

**Update `src/server.tsx`:**
Add API routes for session listing and deletion. These are needed because `createServerFn` in TanStack Start creates RPC-style endpoints (not REST), but the sidebar needs to load sessions on navigation. The server functions handle this automatically via TanStack Start's internal routing, so NO new routes need to be added to server.tsx for the server functions.

However, verify that `createServerFn` works correctly with the current TanStack Start version. If `createServerFn` does not work (v1.159.5 API may differ), fall back to adding explicit API routes in server.tsx:
- `GET /api/sessions` -> return session list
- `DELETE /api/sessions/:id` -> delete session

The preferred approach is `createServerFn` -- only add explicit routes as fallback.
  </action>
  <verify>
  Import and call `listSessions` from a test -- or temporarily add a console.log in a route loader and check dev server output. Verify that `deleteSession` removes a session record. Check that new sessions get a title from the first message.
  </verify>
  <done>
  Server functions for listing sessions (with last message snippet), loading session messages, and deleting sessions are working. New sessions get auto-generated titles from the first user message (first 50 chars trimmed to last word).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sidebar components and restructure routes into pathless layout</name>
  <files>
    src/components/sidebar/Sidebar.tsx
    src/components/sidebar/SessionItem.tsx
    src/routes/_chat.tsx
    src/routes/_chat.index.tsx
    src/routes/_chat.$sessionId.tsx
    src/routes/index.tsx
  </files>
  <action>
**Create `src/components/sidebar/SessionItem.tsx`:**
- Props: `{ session: { id: string, title: string | null, lastMessageSnippet?: string, updatedAt: Date | number }, onDelete: (id: string) => void }`
- Renders as a Link (`@tanstack/react-router` Link) to `/$sessionId` with the session's ID
- Shows title (or "Untitled" fallback) in bold/semibold, truncated with text-ellipsis
- Shows lastMessageSnippet below title in smaller, muted text, truncated to 1 line
- Delete button: small X icon on hover (absolute positioned top-right), calls `onDelete(session.id)` with `e.preventDefault()` + `e.stopPropagation()` to prevent navigation
- Active state: highlight background when current route matches this session (use `useMatchRoute` or Link's `activeProps`)
- Styling: px-3 py-2.5, rounded-lg, hover:bg-gray-100 dark:hover:bg-gray-800, transition

**Create `src/components/sidebar/Sidebar.tsx`:**
- Props: `{ sessions: SessionListItem[], isOpen: boolean, onToggle: () => void, onDelete: (id: string) => void }`
- Layout: fixed-width drawer (w-72) on the left side
- At >= 768px (md): always visible, slides in/out with CSS transform
- At < 768px: overlay mode, slide from left with backdrop
- "New chat" button at top: navigates to `/` (the _chat.index.tsx route), styled as a prominent button
- Below: flat list of SessionItem components, newest first (already sorted by server)
- Scrollable list area (overflow-y-auto, flex-1)
- Toggle button: hamburger icon when closed (visible in both mobile and desktop for consistency)
- Use CSS transitions for slide animation (transform translateX, transition-transform duration-200)

**Create `src/routes/_chat.tsx`** (pathless layout route):
- `createFileRoute('/_chat')` with component and loader
- Loader: calls `listSessions()` server function
- Component (`ChatLayout`):
  - Manages sidebar state: `isOpen` (default true on md+, false on mobile)
  - Uses `useState` for isOpen, detect initial value from `window.innerWidth >= 768` (with SSR-safe check: default true)
  - Layout: `<div className="flex h-screen">` with Sidebar and `<main className="flex-1 flex flex-col min-w-0">`
  - Passes loaded sessions to Sidebar
  - On session delete: call `deleteSession`, then invalidate/refetch the route loader data. Use `router.invalidate()` or re-call the loader
  - Header bar at top of main area: hamburger toggle button (only visible when sidebar is closed), "Wrex" text/logo

**Create `src/routes/_chat.index.tsx`** (empty state / new chat):
- `createFileRoute('/_chat/')` with component
- Component (`NewChat`):
  - Uses `useChat` hook with NO sessionId (new conversation)
  - On session created (from SSE `session` event): navigate to `/$sessionId` using `useNavigate` from TanStack Router
  - Renders ChatMessages + ChatInput from 03-01 components
  - Full height flex layout within the Outlet area
  - Empty state per user decision: blank chat area with input box ready, no welcome message or tips

**Create `src/routes/_chat.$sessionId.tsx`** (active session):
- `createFileRoute('/_chat/$sessionId')` with component and loader
- Loader: `({ params }) => loadSessionMessages({ data: { sessionId: params.sessionId } })`
- Component (`ChatSession`):
  - Gets loader data with session messages and metadata
  - Maps loaded messages to `ChatMessage[]` format for useChat initialMessages
  - Uses `useChat` hook with `sessionId` from params and `initialMessages` from loader
  - Renders ChatMessages + ChatInput
  - On unmount: useChat cleanup aborts any active stream

**Update `src/routes/index.tsx`:**
- Replace with a simple redirect to `/_chat` layout. Since `_chat` is a pathless layout, the index route at `/` should render the `_chat.index.tsx` component.
- Actually, with TanStack Router pathless layouts, `_chat.tsx` wraps child routes without adding a URL segment. So `/` maps to `_chat.index.tsx` and `/$sessionId` maps to `_chat.$sessionId.tsx`.
- IMPORTANT: The pathless layout `_chat.tsx` means the routes are:
  - `/` -> `_chat.tsx` layout + `_chat.index.tsx` content
  - `/$sessionId` -> `_chat.tsx` layout + `_chat.$sessionId.tsx` content
- DELETE `src/routes/index.tsx` since `_chat.index.tsx` handles the `/` route now. If TanStack Router requires an explicit index.tsx, keep it as a redirect to `/` which will be caught by the pathless layout.
- Test: if deleting index.tsx causes issues, convert it to: `export const Route = createFileRoute('/')({ component: () => { const nav = useNavigate(); useEffect(() => nav({ to: '/' }), []); return null } })`. But likely `_chat.index.tsx` handles `/` directly.

**Route structure verification:**
The pathless layout `_chat` means these URL paths:
- `/` -> renders `_chat.tsx` > `_chat.index.tsx`
- `/abc-123` -> renders `_chat.tsx` > `_chat.$sessionId.tsx` with params.sessionId = 'abc-123'

This works because `_chat` has no URL segment (prefixed with `_`). Verify this is correct by checking TanStack Router docs reference in the research.

**Sidebar refresh after actions:**
When a new session is created or a session is deleted, the sidebar session list needs to refresh. Use `router.invalidate()` from `useRouter()` to re-run the _chat layout loader, which will re-fetch `listSessions()`.
  </action>
  <verify>
  Run `npx vite dev` and verify:
  1. `/` shows the chat layout with sidebar on the left and empty chat area
  2. Sidebar shows "New chat" button and any existing sessions
  3. Sending a message creates a session and navigates to `/$sessionId`
  4. Clicking a session in the sidebar loads its message history
  5. Delete button removes a session from the list
  6. On narrow viewport (< 768px), sidebar collapses to hamburger menu
  7. `npx tsc --noEmit` passes
  </verify>
  <done>
  Chat application has sidebar navigation with session list (newest first), new chat button, session resume via route navigation, auto-generated titles, instant deletion, and responsive collapsible drawer. Routes use TanStack Router pathless layout for persistent sidebar across all views.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles without errors
2. `/` renders sidebar + empty chat (no welcome message)
3. Sending first message creates session with auto-generated title
4. Session appears in sidebar immediately after creation
5. Navigating away and clicking session in sidebar loads full history
6. Continuing a conversation in a loaded session works (messages append)
7. Delete button removes session, sidebar updates
8. Sidebar responsive: visible drawer on desktop, hamburger on mobile
</verification>

<success_criteria>
- Sidebar shows flat session list sorted by recency with title + last message snippet
- "New chat" button navigates to empty chat state
- Clicking past session loads full message history, input ready to continue
- Sessions get title from first user message (first 50 chars, trimmed to word)
- Instant session deletion (no confirmation)
- Sidebar collapses to hamburger on < 768px
- Empty state: blank chat area with input box, no welcome message
- Route-based navigation: / for new chat, /$sessionId for existing
</success_criteria>

<output>
After completion, create `.planning/phases/03-chat-experience/03-02-SUMMARY.md`
</output>
